{% extends 'base.html' %}
{% block title %}Báo cáo Sản xuất{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary"><i class="bi bi-bar-chart-line-fill"></i> Báo Cáo Sản Xuất</h2>
        <div>
            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#exportExcelModal" onclick="syncExportDates()">
                <i class="bi bi-file-earmark-excel-fill"></i> Xuất Báo cáo Excel
            </button>
            <a href="{{ url_for('main.main_menu') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Quay lại Menu
            </a>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end" id="filter-form">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Từ ngày</label>
                    <input type="date" class="form-control" id="start-date" name="start_date" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Đến ngày</label>
                    <input type="date" class="form-control" id="end-date" name="end_date" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">KCS (Tùy chọn)</label>
                    <select class="form-select" id="inspector-select">
                        <option value="">-- Tất cả --</option>
                        {% for insp in all_inspectors %}
                            <option value="{{ insp.personnel_id }}">{{ insp.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-primary w-100" onclick="loadReports()">
                        <i class="bi bi-funnel-fill"></i> Xem Báo Cáo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header fw-bold">Biểu đồ Lỗi (Pareto)</div>
                <div class="card-body">
                    <canvas id="paretoChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header fw-bold">Năng suất Máy</div>
                <div class="card-body">
                    <canvas id="machineChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="reportTabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary-pane">Tổng hợp SX</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="individual-tab" data-bs-toggle="tab" data-bs-target="#individual-pane">Sản lượng Cá nhân</button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <div class="tab-pane fade show active" id="summary-pane">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle" id="summary-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>Ngày</th>
                                    <th>Mã Cây</th>
                                    <th>LSX</th>
                                    <th>Vải</th>
                                    <th>KCS</th>
                                    <th class="text-end">Tổng Mét</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="individual-pane">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle" id="individual-table">
                            <thead class="table-secondary">
                                <tr>
                                    <th>Ngày</th>
                                    <th>Mã Cây</th>
                                    <th>Công nhân</th>
                                    <th>Ca</th>
                                    <th class="text-end">G1 (m)</th>
                                    <th class="text-end">G2 (m)</th>
                                    <th>KCS Duyệt</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="exportExcelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-file-earmark-spreadsheet"></i> Tùy chọn Xuất Excel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('api_report.export_custom_excel') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <p class="mb-2 fw-bold text-dark">Chọn khoảng thời gian xuất báo cáo:</p>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label small text-muted">Từ ngày</label>
                                <input type="date" class="form-control" name="start_date" id="export_start_date" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-muted">Đến ngày</label>
                                <input type="date" class="form-control" name="end_date" id="export_end_date" required>
                            </div>
                        </div>
                    </div>
                    
                    <hr>

                    <div class="mb-3">
                        <label class="form-label fw-bold text-success">Loại báo cáo:</label>
                        <div class="list-group">
                            <label class="list-group-item list-group-item-action">
                                <input class="form-check-input me-1" type="radio" name="report_type" value="general" checked onchange="toggleShiftSelect()">
                                Tổng hợp theo Đơn hàng / Vải
                            </label>
                            <label class="list-group-item list-group-item-action">
                                <input class="form-check-input me-1" type="radio" name="report_type" value="worker" onchange="toggleShiftSelect()">
                                Sản lượng Công nhân (Theo Ca)
                            </label>
                            <label class="list-group-item list-group-item-action">
                                <input class="form-check-input me-1" type="radio" name="report_type" value="qc" onchange="toggleShiftSelect()">
                                Sản lượng KCS
                            </label>
                        </div>
                    </div>

                    <div class="mb-3 p-3 bg-light rounded" id="shift-select-container" style="display: none;">
                        <label class="form-label fw-bold text-primary">Chọn Ca làm việc:</label>
                        <select class="form-select" name="shift">
                            <option value="">-- Tất cả các Ca --</option>
                            <option value="1">Ca 1 (Sáng)</option>
                            <option value="2">Ca 2 (Chiều)</option>
                            <option value="3">Ca 3 (Đêm)</option>
                        </select>
                        <div class="form-text small">Chỉ áp dụng cho báo cáo công nhân.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-success fw-bold">
                        <i class="bi bi-download"></i> Tải về (.xlsx)
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Khởi tạo ngày mặc định là hôm nay cho Dashboard chính
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('start-date').value = today;
    document.getElementById('end-date').value = today;

    // --- CHART INSTANCES ---
    let paretoChart = null;
    let machineChart = null;

    // [JS] Đồng bộ ngày từ form chính vào Modal Export (Updated)
    function syncExportDates() {
        // Lấy giá trị từ bộ lọc chính
        const mainStart = document.getElementById('start-date').value;
        const mainEnd = document.getElementById('end-date').value;

        // Gán vào input trong modal (vẫn cho phép sửa nếu cần)
        document.getElementById('export_start_date').value = mainStart;
        document.getElementById('export_end_date').value = mainEnd;
    }

    // [JS] Ẩn/Hiện dropdown chọn Ca dựa trên loại báo cáo
    function toggleShiftSelect() {
        // Lấy value của radio button đang được check
        const reportType = document.querySelector('input[name="report_type"]:checked').value;
        const shiftContainer = document.getElementById('shift-select-container');
        
        // Logic hiển thị: Chỉ hiện khi chọn "worker" (Sản lượng Công nhân)
        // Lưu ý: Value này phải khớp với value trong thẻ input radio ở trên ('worker')
        if (reportType === 'worker') {
            shiftContainer.style.display = 'block';
        } else {
            shiftContainer.style.display = 'none';
        }
    }

    // Hàm tải báo cáo chính (Table & Chart)
    async function loadReports() {
        const start = document.getElementById('start-date').value;
        const end = document.getElementById('end-date').value;
        const inspector = document.getElementById('inspector-select').value;
        
        // 1. Load Table Data
        // Lưu ý: Đảm bảo route trong url_for khớp với api_report.py
        await loadTable("{{ url_for('api_report.api_production_summary') }}", start, end, inspector, 'summary-table', renderSummaryRow);
        await loadTable("{{ url_for('api_report.api_individual_summary') }}", start, end, inspector, 'individual-table', renderIndividualRow);
        
        // 2. Load Chart Data
        loadCharts(start, end);
    }

    // --- HÀM 1: LOAD TABLE ---
    async function loadTable(url, start, end, inspector, tableId, renderRowFn) {
        const tbody = document.querySelector(`#${tableId} tbody`);
        tbody.innerHTML = '<tr><td colspan="10" class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading...</td></tr>';
        
        try {
            const query = `?start_date=${start}&end_date=${end}&inspector_id=${inspector}`;
            const res = await fetch(url + query);
            
            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                const text = await res.text();
                // Xử lý chuyển hướng nếu hết phiên đăng nhập
                if (res.url.includes('/login')) {
                    window.location.href = '/login'; 
                    return;
                }
                throw new Error(`Lỗi Server: ${text.substring(0, 50)}...`);
            }

            const data = await res.json();
            
            tbody.innerHTML = '';
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">Không có dữ liệu</td></tr>';
                return;
            }

            data.forEach(row => {
                tbody.innerHTML += renderRowFn(row);
            });
        } catch (e) {
            console.error("Table Error:", e);
            tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">Lỗi: ${e.message}</td></tr>`;
        }
    }

    function renderSummaryRow(r) {
        return `
            <tr>
                <td>${new Date(r.inspection_date).toLocaleDateString('vi-VN')}</td>
                <td class="fw-bold">${r.roll_number}</td>
                <td>${r.order_number || '-'}</td>
                <td>${r.fabric_name}</td>
                <td>${r.inspector_name || '-'}</td>
                <td class="text-end fw-bold text-primary">${parseFloat(r.total_meters).toFixed(2)}</td>
            </tr>
        `;
    }

    function renderIndividualRow(r) {
        return `
            <tr>
                <td>${new Date(r.inspection_date).toLocaleDateString('vi-VN')}</td>
                <td class="fw-bold">${r.roll_number}</td>
                <td>${r.full_name}</td>
                <td><span class="badge bg-secondary">Ca ${r.shift}</span></td>
                <td class="text-end">${parseFloat(r.meters_grade1).toFixed(2)}</td>
                <td class="text-end">${parseFloat(r.meters_grade2).toFixed(2)}</td>
                <td>${r.inspector_name || '-'}</td>
            </tr>
        `;
    }

    // --- HÀM 2: LOAD CHARTS ---
    async function loadCharts(start, end) {
        const url = "{{ url_for('api_report.api_analytics_data') }}";
        
        try {
            const res = await fetch(`${url}?start_date=${start}&end_date=${end}`);
            if (res.ok) {
                const data = await res.json();
                
                // Render Pareto
                const ctx1 = document.getElementById('paretoChart').getContext('2d');
                if (paretoChart) paretoChart.destroy();
                
                paretoChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: data.pareto.map(x => x.error_type),
                        datasets: [{
                            label: 'Số lần lỗi',
                            data: data.pareto.map(x => x.frequency),
                            backgroundColor: 'rgba(255, 99, 132, 0.6)'
                        }]
                    }
                });

                // Render Machine Perf
                const ctx2 = document.getElementById('machineChart').getContext('2d');
                if (machineChart) machineChart.destroy();

                machineChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: data.machine_performance.map(x => x.machine_id),
                        datasets: [{
                            label: 'Sản lượng (m)',
                            data: data.machine_performance.map(x => x.total_meters),
                            backgroundColor: 'rgba(54, 162, 235, 0.6)'
                        }]
                    },
                    options: { indexAxis: 'y' }
                });
            }
        } catch (e) { 
            console.error("Chart Error:", e); 
        }
    }

    // Tự động tải dữ liệu khi trang vừa mở
    loadReports();
</script>
{% endblock %}